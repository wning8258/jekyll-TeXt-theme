---
layout: post
title: 计算机网络
key: 20181124 计算机网络
tags: 计算机网络 TCP UDP
---

#计算机网络

计算机网络分为5层协议：

1. 应用层
2. 运输层
3. 网络层
4. 数据链路层
5. 物理层

## 1.应用层

作为体系结构中的最高层，**应用层的作用是通过运用进程间的交互来完成特定的网络应用。应用层协议定义的是应用进程间的通信和交互的规则。**

这里的进程指的是正在运行的程序。并且对于不同的应用需要不同的协议。比如：在浏览器上我们浏览网页，浏览器向服务器请求数据就是通过HTTP协议。我们发送邮件采用的是SMTP协议。进行文件传输可以采用FTP协议。查找域名IP采用的是DNS协议等。应用层之间的交互数据单元为报文。什么是报文呢？就拿HTTP写来说，我们无论是发送请求或者接受响应都是通过报文的格式。在我一篇HTTP协议文章解释了报文的内容，其中包括报文报文首部(请求行)、消息报头、报文主体。如下图： 

![image-20181124184330469](https://ws3.sinaimg.cn/large/006tNbRwly1fxjcbmzj6dj30sw08q76v.jpg)



## 2.运输层

**运输层的任务是负责向两个主机中进程之间的通信提供通用的数据传输服务。**

运用层进程利用该服务传送应用层报文。还是以HTTP协议为例，HTTP协议之所以属于应用层，是因为HTTP协议只是为请求和接收指定规则，并不负责主机之间的报文传输工作。这个工作是交给处于运输层的协议。在这里解释一下通用的概念，在应用层对于不同功能的运用进程需要不同的协议，但是运输层并不针对特定的应用层运用（协议）,多种应用（浏览器请求响应、发送邮件、FTP文件传输）都可以使用同一个运输层服务。由于一台主机允许多个进程同时进行，所以运输层有复用和分用的功能。**复用就是多个应用层进程可以同时使用运输层服务，分用就是运输层可以将收到的信息分别交给不同的运用层进程。 **
主要的两种运输层协议： 
i、传输控制协议 TCP（Transmission Control Protocol） 
TCP协议是一种面向连接的、可靠地数据传输服务，传输的单位是报文段，也就是说，通过TCP连接传送的数据，无差错、不丢失、不重复、并且按序到达，TCP提供全双工通信，**TCP是面向字节流的，TCP把应用程序交下来的数据块看成无结构的字节流**，TCP不保证接收方应用程序收到的数据块和发送方应用程序所发出的数据块具有对应的大小关系。例如： 
发送方应用程序交给发送方TCP共10个数据块，但接收方的TCP可能只用4个数据块就把收到的字节流交付给了上层的应用程序，但接收方应用程序收到的字节流必须和发送方应用程序发出的字节流完全一样）。
ii、用户数据报协议 UDP （User Datagram Protocol）
提供无连接的、尽最大努力的数据传输服务（不保证数据传输的可靠性），UDP是面向报文的，UDP没有拥塞控制，因此网络出现的拥塞不会使源主机发送速率降低，UDP支持一对一、一对多、多对一、多对多的交互通信，UDP的首部开销小。其数据传输的单位是用户数据报。

###2.1 TCP和UDP的区别

TCP:

- 面向连接，使用TCP协议之前，必须要先建立TCP连接，传送数据完毕后，必须释放连接（3次握手4次挥手）
- TCP只有能两个端点，是点对点的（一对一的）
- TCP提供可靠交付的服务，通过TCP连接传送的数据，无差错，无丢失，不重复，并且按序到达（因为TCP的头部里有序列号，发送完就停止发送，进行等待确认，传输过程中出现差错会进行超时重传)
- TCP提供全双工通信（允许双方任何时候都能发送数据，两端都设有发送缓存和接收缓存）

![image-20181124204948963](https://ws3.sinaimg.cn/large/006tNbRwly1fxjfyzdw61j30z80ban9m.jpg)

（

1. 单工数据传输只支持数据在一个方向上传输；在同一时间只有一方能接受或发送信息，不能实现双向通信，举例：电视，广播

2. 半双工数据传输允许数据在两个方向上传输,但是,在某一时刻,只允许数据在一个方向上传输,它实际上是一种切换方向的单工通信,在同一时间只可以有一方接受或发送信息，可以实现双向通信。举例：对讲机。
3. 全双工数据通信允许数据同时在两个方向上传输,因此,全双工通信是两个单工通信方式的结合,它要求发送设备和接收设备都有独立的接收和发送能力；在同一时间可以同时接受和发送信息，实现双向通信，举例：电话通信

）

- 面向字节流
- 首部有20个字节

UDP:

- 无连接，发送数据之前不需要建立连接（减少了开销和发送数据的之前的时延）
- 尽最大努力交付，但是不保证可靠交付
- 面向报文（发送方把应用程序交下来的报文添加首部后，就交付给ip层，udp不拆分不合并，应用层交给udp多长的报文，udp就照样发送）
- 没有拥塞控制（所以可以用于实时应用）
- 支持一对一，一对多，多对一，多对多的交互通信
- UDP首部开销小，只有8个字节

### 2.2 TCP为什么是可靠连接

- 通过 TCP 连接传输的数据无差错，不丢失，不重复，且按顺序到达。

- TCP 报文头里面的序号能使 TCP 的数据按序到达

- 报文头里面的确认序号能保证不丢包，累计确认及超时重传机制

- TCP 拥有流量控制及拥塞控制的机制

### 2.3 TCP的三次握手(及四次挥手)

Tcp的报头：

![image-20181022135840891](https://ws1.sinaimg.cn/large/006tNbRwgy1fwjd0fro5oj30xk0ka40k.jpg)

1. 源端口和目的端口，各占2个字节，分别写入源端口和目的端口；

   ![image-20181022153305479](https://ws4.sinaimg.cn/large/006tNbRwgy1fwjd0cfzegj31bu09ydha.jpg)	

1. **序号，占4个字节，TCP连接中传送的字节流中的每个字节都按顺序编号。例如，一段报文的序号字段值是 301 ，而携带的数据共有100字段，显然下一个报文段（如果还有的话）的数据序号应该从401开始；**
2. **确认号，占4个字节，是期望收到对方下一个报文的第一个数据字节的序号。例如，B收到了A发送过来的报文，其序列号字段是501，而数据长度是200字节，这表明B正确的收到了A发送的到序号700为止的数据。因此，B期望收到A的下一个数据序号是701，于是B在发送给A的确认报文段中把确认号置为701；**
3. 数据偏移，占4位，它指出TCP报文的数据距离TCP报文段的起始处有多远；
4. 保留，占6位，保留今后使用，但目前应都位0；
5. 紧急URG，当URG=1，表明紧急指针字段有效。告诉系统此报文段中有紧急数据；
6. **确认ACK，仅当ACK=1时，确认号字段才有效。TCP规定，在连接建立后所有报文的传输都必须把ACK置1；**
7. 推送PSH，当两个应用进程进行交互式通信时，有时在一端的应用进程希望在键入一个命令后立即就能收到对方的响应，这时候就将PSH=1；
8. 复位RST，当RST=1，表明TCP连接中出现严重差错，必须释放连接，然后再重新建立连接；
9. **同步SYN，在连接建立时用来同步序号。当SYN=1，ACK=0，表明是连接请求报文，若同意连接，则响应报文中应该使SYN=1，ACK=1；**
10. **终止FIN，用来释放连接。当FIN=1，表明此报文的发送方的数据已经发送完毕，并且要求释放；**
11. 窗口，占2字节，指的是通知接收方，发送本报文你需要有多大的空间来接受；
12. 检验和，占2字节，校验首部和数据这两部分；
13. 紧急指针，占2字节，指出本报文段中的紧急数据的字节数；
14. 选项，长度可变，定义一些其他的可选的参数。

####2.3.1 三次握手

![image-20181022140616946](https://ws1.sinaimg.cn/large/006tNbRwgy1fwjd0k2w72j31kw0xldkj.jpg)



- TCP服务器进程先创建传输控制块TCB，时刻准备接受客户进程的连接请求，此时服务器就进入了LISTEN（监听）状态；
- TCP客户进程也是先创建传输控制块TCB，然后向服务器发出连接请求报文，这是报文首部中的同部位SYN=1，同时选择一个初始序列号 seq=x ，此时，TCP客户端进程进入了 SYN-SENT（同步已发送状态）状态。**TCP规定，SYN报文段（SYN=1的报文段）不能携带数据，但需要消耗掉一个序号。**
- TCP服务器收到请求报文后，如果同意连接，则发出确认报文。确认报文中应该 ACK=1，SYN=1，确认号是ack=x+1，同时也要为自己初始化一个序列号 seq=y，此时，TCP服务器进程进入了SYN-RCVD（同步收到）状态。**这个报文也不能携带数据，但是同样要消耗一个序号。**
- TCP客户进程收到确认后，还要向服务器给出确认。确认报文的ACK=1，ack=y+1，自己的序列号seq=x+1，此时，TCP连接建立，客户端进入ESTABLISHED（已建立连接）状态。**TCP规定，ACK报文段可以携带数据，但是如果不携带数据则不消耗序号。**
- 当服务器收到客户端的确认后也进入ESTABLISHED状态，此后双方就可以开始通信了

(位码即tcp标志位,有6种标示:SYN(synchronous建立联机) ACK(acknowledgement 确认) PSH(push传送) FIN(finish结束) RST(reset重置) URG(urgent紧急)

Sequence number(顺序号码) Acknowledge number(确认号码)

第一次握手：主机A发送位码为syn＝1,随机产生seq number=1234567的数据包到服务器，主机B由SYN=1知道，A要求建立联机；

第二次握手：主机B收到请求后要确认联机信息，向A发送ack number=(主机A的seq+1),syn=1,ack=1,随机产生seq=7654321的包

第三次握手：主机A收到后检查ack number是否正确，即第一次发送的seq number+1,以及位码ack是否为1，若正确，主机A会再发送ack number=(主机B的seq+1),ack=1，主机B收到后确认seq值与ack=1则连接建立成功。

完成三次握手，主机A与主机B开始传送数据。)

![image-20181022143129688](https://ws2.sinaimg.cn/large/006tNbRwgy1fwjd0gb146j30xe0iy7a7.jpg)

####2.3.2 四次挥手

![image-20181022143838972](https://ws2.sinaimg.cn/large/006tNbRwgy1fwjd0jiy4zj31jq0ukn1d.jpg)

- 客户端进程发出连接释放报文，并且停止发送数据。释放数据报文首部，FIN=1，其序列号为seq=u（等于前面已经传送过来的数据的最后一个字节的序号加1），此时，客户端进入FIN-WAIT-1（终止等待1）状态。 TCP规定，FIN报文段即使不携带数据，也要消耗一个序号。
- 服务器收到连接释放报文，发出确认报文，ACK=1，ack=u+1，并且带上自己的序列号seq=v，此时，服务端就进入了CLOSE-WAIT（关闭等待）状态。TCP服务器通知高层的应用进程，客户端向服务器的方向就释放了，这时候处于半关闭状态，即客户端已经没有数据要发送了，但是服务器若发送数据，客户端依然要接受。这个状态还要持续一段时间，也就是整个CLOSE-WAIT状态持续的时间。
- 客户端收到服务器的确认请求后，此时，客户端就进入FIN-WAIT-2（终止等待2）状态，等待服务器发送连接释放报文（在这之前还需要接受服务器发送的最后的数据）。
- 服务器将最后的数据发送完毕后，就向客户端发送连接释放报文，FIN=1，ack=u+1，由于在半关闭状态，服务器很可能又发送了一些数据，假定此时的序列号为seq=w，此时，服务器就进入了LAST-ACK（最后确认）状态，等待客户端的确认。
- 客户端收到服务器的连接释放报文后，必须发出确认，ACK=1，ack=w+1，而自己的序列号是seq=u+1，此时，客户端就进入了TIME-WAIT（时间等待）状态。**注意此时TCP连接还没有释放，必须经过2MSL（最长报文段寿命）的时间后，当客户端撤销相应的TCB后，才进入CLOSED状态。**
- 服务器只要收到了客户端发出的确认，立即进入CLOSED状态。同样，撤销TCB后，就结束了这次的TCP连接。可以看到，服务器结束TCP连接的时间要比客户端早一些。

1. **为什么客户端最后还要等待2MSL？**

MSL（Maximum Segment Lifetime），TCP允许不同的实现可以设置不同的MSL值。

第一，保证客户端发送的最后一个ACK报文能够到达服务器，因为这个ACK报文可能丢失，站在服务器的角度看来，我已经发送了FIN+ACK报文请求断开了，客户端还没有给我回应，应该是我发送的请求断开报文它没有收到，于是服务器又会重新发送一次，而客户端就能在这个2MSL时间段内收到这个重传的报文，接着给出回应报文，并且会重启2MSL计时器。

第二，防止类似与“三次握手”中提到了的“已经失效的连接请求报文段”出现在本连接中。客户端发送完最后一个确认报文后，在这个2MSL时间中，就可以使本连接持续的时间内所产生的所有报文段都从网络中消失。这样新的连接中不会出现旧连接的请求报文。

2. **为什么建立连接是三次握手，关闭连接确是四次挥手呢？**

建立连接的时候， 服务器在LISTEN状态下，收到建立连接请求的SYN报文后，把ACK和SYN放在一个报文里发送给客户端。 

而关闭连接时，服务器收到对方的FIN报文时，仅仅表示对方不再发送数据了但是还能接收数据，而自己也未必全部数据都发送给对方了，所以己方可以立即关闭，也可以发送一些数据给对方后，再发送FIN报文给对方来表示同意现在关闭连接，因此，己方ACK和FIN一般都会分开发送，从而导致多了一次。

## 3.网络层

网络层负责为分组交换网不同的主机提供通信服务，在发送数据时，网络层是把运输层产生的报文段或者用户数据报分装成报进行传输。网络层使用的是IP协议，所以也叫做IP数据报简称为数据报。网络层不提供服务质量的承诺，IP数据报首部中的检验和字段，只检验首部是否出现差错而不检查数据部分。如果主机中的进程之间的通信需要是可靠的，那么就由网络的主机中的运输层负责（包括差错处理、流量控制等）。IP协议是该层的核心协议，IP协议的主要功能就是无连接的数据报传输、数据报路由选择。

## 4.数据链路层

数据链路层的作用是将网络层交下来的IP数据报组装成帧。每一帧包括数据和必要的控制信息(同步信息、地址信息、差错控制) 
在接受数据时，控制信息使接收端能够知道一个帧从那个比特开始到哪个比特结束，当数据链路层接收到一个帧后就可以提取数据部分，然后提交到网络层。 
控制信息还可以使得接收端检测到所收的帧有无差错，发现差错就放弃差错的帧，然后采用可靠传输协议来纠正出现的差错。 

数据链路层协议有许多种，但是有三个基本问题则是共同的，这三个问题就是：封装成帧、透明传输、差错检测。关于差错控制，比特在传输过程中可能0变1，1变0，这叫做比特差错，数据链路层广泛使用了循环冗余检验CRC（Cyclic Redundancy Check）。数据链路层使用两种信道：点对点信道和广播信道，点对点协议PPP（point-to-point protocol）则是点对点信道常用的协议，也是该层最广泛的协议，工作在该层的硬件是网桥。

## 5.物理层

物理层不是指具体的物理设备或者信号传输的物理媒体（包括双绞线、同轴电缆等），而是指在物理媒体之上为上一层（链路层）提供一个传输原始比特流的物理连接。它的作用在于为链路层传输比特流。

最后通过两个主机之间的一次数据传输来理解各层之间的关系以及作用 

![image-20181124185912568](https://ws2.sinaimg.cn/large/006tNbRwly1fxjcrwmjtsj31cs0pc7bt.jpg)

